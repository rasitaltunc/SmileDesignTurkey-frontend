{"version":3,"file":"ProductTourTooltip.js","sourceRoot":"","sources":["../../../../../src/extensions/product-tours/components/ProductTourTooltip.tsx"],"names":[],"mappings":"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","sourcesContent":["import { h } from 'preact'\nimport { useEffect, useState, useCallback, useRef } from 'preact/hooks'\nimport { ProductTour, ProductTourStep, ProductTourDismissReason } from '../../../posthog-product-tours-types'\nimport {\n    calculateTooltipPosition,\n    getSpotlightStyle,\n    mergeAppearance,\n    renderTipTapContent,\n    TooltipPosition,\n} from '../product-tours-utils'\nimport { addEventListener } from '../../../utils'\nimport { window as _window } from '../../../utils/globals'\nimport { IconPosthogLogo, cancelSVG } from '../../surveys/icons'\n\nconst window = _window as Window & typeof globalThis\n\ntype TransitionState = 'initializing' | 'entering' | 'visible' | 'exiting'\n\nexport interface ProductTourTooltipProps {\n    tour: ProductTour\n    step: ProductTourStep\n    stepIndex: number\n    totalSteps: number\n    targetElement: HTMLElement | null\n    onNext: () => void\n    onPrevious: () => void\n    onDismiss: (reason: ProductTourDismissReason) => void\n}\n\nfunction getOppositePosition(position: TooltipPosition): TooltipPosition {\n    const opposites: Record<TooltipPosition, TooltipPosition> = {\n        top: 'bottom',\n        bottom: 'top',\n        left: 'right',\n        right: 'left',\n    }\n    return opposites[position]\n}\n\nfunction scrollToElement(element: HTMLElement, resolve: () => void): void {\n    const initialRect = element.getBoundingClientRect()\n    const viewportHeight = window.innerHeight\n    const viewportWidth = window.innerWidth\n\n    const safeMarginY = viewportHeight / 6\n    const safeMarginX = viewportWidth / 6\n\n    const isInSafeZone =\n        initialRect.top >= safeMarginY &&\n        initialRect.bottom <= viewportHeight - safeMarginY &&\n        initialRect.left >= safeMarginX &&\n        initialRect.right <= viewportWidth - safeMarginX\n\n    if (isInSafeZone) {\n        resolve()\n        return\n    }\n\n    element.scrollIntoView({ behavior: 'smooth', block: 'center' })\n\n    let lastTop = initialRect.top\n    let stableCount = 0\n    let resolved = false\n\n    const checkStability = () => {\n        if (resolved) return\n\n        const currentRect = element.getBoundingClientRect()\n        if (Math.abs(currentRect.top - lastTop) < 1) {\n            stableCount++\n            if (stableCount >= 3) {\n                resolved = true\n                resolve()\n                return\n            }\n        } else {\n            stableCount = 0\n        }\n        lastTop = currentRect.top\n        setTimeout(checkStability, 50)\n    }\n\n    setTimeout(checkStability, 30)\n\n    setTimeout(() => {\n        if (!resolved) {\n            resolved = true\n            resolve()\n        }\n    }, 500)\n}\n\nexport function ProductTourTooltip({\n    tour,\n    step,\n    stepIndex,\n    totalSteps,\n    targetElement,\n    onNext,\n    onPrevious,\n    onDismiss,\n}: ProductTourTooltipProps): h.JSX.Element {\n    const appearance = mergeAppearance(tour.appearance)\n    const [transitionState, setTransitionState] = useState<TransitionState>('initializing')\n    const [position, setPosition] = useState<ReturnType<typeof calculateTooltipPosition> | null>(null)\n    const [spotlightStyle, setSpotlightStyle] = useState<ReturnType<typeof getSpotlightStyle> | null>(null)\n\n    const [displayedStep, setDisplayedStep] = useState(step)\n    const [displayedStepIndex, setDisplayedStepIndex] = useState(stepIndex)\n\n    const previousStepRef = useRef(stepIndex)\n    const isTransitioningRef = useRef(false)\n    const isFirstRender = useRef(true)\n\n    const isModalStep = !targetElement\n\n    const updatePosition = useCallback(() => {\n        if (isModalStep) {\n            return\n        }\n        const rect = targetElement.getBoundingClientRect()\n        setPosition(calculateTooltipPosition(rect))\n        setSpotlightStyle(getSpotlightStyle(rect))\n    }, [targetElement, isModalStep])\n\n    useEffect(() => {\n        const isStepChange = previousStepRef.current !== stepIndex\n\n        const currentStepIndex = stepIndex\n\n        if (isFirstRender.current) {\n            isFirstRender.current = false\n            previousStepRef.current = stepIndex\n            isTransitioningRef.current = true\n\n            if (isModalStep) {\n                // Modal steps are just centered on screen - no positioning needed\n                setTransitionState('visible')\n                isTransitioningRef.current = false\n                return\n            }\n\n            scrollToElement(targetElement, () => {\n                if (previousStepRef.current !== currentStepIndex) {\n                    return\n                }\n\n                const rect = targetElement.getBoundingClientRect()\n                setPosition(calculateTooltipPosition(rect))\n                setSpotlightStyle(getSpotlightStyle(rect))\n                setTransitionState('visible')\n                isTransitioningRef.current = false\n            })\n            return\n        }\n\n        if (isStepChange) {\n            previousStepRef.current = stepIndex\n            isTransitioningRef.current = true\n\n            setTransitionState('exiting')\n\n            setTimeout(() => {\n                if (previousStepRef.current !== currentStepIndex) {\n                    return\n                }\n\n                setDisplayedStep(step)\n                setDisplayedStepIndex(stepIndex)\n                setTransitionState('entering')\n\n                if (isModalStep) {\n                    // Modal steps don't need scrolling or position calculation\n                    setTimeout(() => {\n                        if (previousStepRef.current !== currentStepIndex) {\n                            return\n                        }\n                        setTransitionState('visible')\n                        isTransitioningRef.current = false\n                    }, 50)\n                    return\n                }\n\n                scrollToElement(targetElement, () => {\n                    if (previousStepRef.current !== currentStepIndex) {\n                        return\n                    }\n\n                    updatePosition()\n                    setTimeout(() => {\n                        if (previousStepRef.current !== currentStepIndex) {\n                            return\n                        }\n                        setTransitionState('visible')\n                        isTransitioningRef.current = false\n                    }, 50)\n                })\n            }, 150)\n        }\n    }, [targetElement, stepIndex, step, updatePosition, isModalStep])\n\n    useEffect(() => {\n        if (transitionState !== 'visible' || isModalStep) {\n            return\n        }\n\n        const handleUpdate = () => {\n            if (!isTransitioningRef.current) {\n                updatePosition()\n            }\n        }\n\n        addEventListener(window, 'scroll', handleUpdate as EventListener, { capture: true })\n        addEventListener(window, 'resize', handleUpdate as EventListener)\n\n        return () => {\n            window?.removeEventListener('scroll', handleUpdate, true)\n            window?.removeEventListener('resize', handleUpdate)\n        }\n    }, [updatePosition, transitionState, isModalStep])\n\n    useEffect(() => {\n        const handleKeyDown = (e: KeyboardEvent) => {\n            if (e.key === 'Escape') {\n                onDismiss('escape_key')\n            }\n        }\n        addEventListener(window, 'keydown', handleKeyDown as EventListener)\n        return () => {\n            window?.removeEventListener('keydown', handleKeyDown)\n        }\n    }, [onDismiss])\n\n    const handleOverlayClick = (e: MouseEvent) => {\n        e.stopPropagation()\n        onDismiss('user_clicked_outside')\n    }\n\n    const handleTooltipClick = (e: MouseEvent) => {\n        e.stopPropagation()\n    }\n\n    const isLastStep = displayedStepIndex >= totalSteps - 1\n    const isFirstStep = displayedStepIndex === 0\n\n    const containerStyle = {\n        '--ph-tour-background-color': appearance.backgroundColor,\n        '--ph-tour-text-color': appearance.textColor,\n        '--ph-tour-button-color': appearance.buttonColor,\n        '--ph-tour-button-text-color': appearance.buttonTextColor,\n        '--ph-tour-border-radius': `${appearance.borderRadius}px`,\n        '--ph-tour-border-color': appearance.borderColor,\n    } as h.JSX.CSSProperties\n\n    const isReady = isModalStep || (transitionState !== 'initializing' && position && spotlightStyle)\n    const isVisible = transitionState === 'visible'\n\n    if (!isReady) {\n        return (\n            <div class=\"ph-tour-container\" style={containerStyle}>\n                <div class=\"ph-tour-click-overlay\" onClick={handleOverlayClick} />\n                <div class=\"ph-tour-spotlight\" style={{ top: '50%', left: '50%', width: '0px', height: '0px' }} />\n            </div>\n        )\n    }\n\n    // Modal step: centered on screen with overlay dimming, no spotlight/arrow\n    if (isModalStep) {\n        return (\n            <div class=\"ph-tour-container\" style={containerStyle}>\n                <div class=\"ph-tour-click-overlay\" onClick={handleOverlayClick} />\n                <div class=\"ph-tour-modal-overlay\" />\n                <div class=\"ph-tour-tooltip ph-tour-tooltip--modal\" onClick={handleTooltipClick}>\n                    <button\n                        class=\"ph-tour-dismiss\"\n                        onClick={() => onDismiss('user_clicked_skip')}\n                        aria-label=\"Close tour\"\n                    >\n                        {cancelSVG}\n                    </button>\n\n                    <div\n                        class=\"ph-tour-content\"\n                        dangerouslySetInnerHTML={{ __html: renderTipTapContent(displayedStep.content) }}\n                    />\n\n                    <div class=\"ph-tour-footer\">\n                        <span class=\"ph-tour-progress\">\n                            {displayedStepIndex + 1} of {totalSteps}\n                        </span>\n\n                        <div class=\"ph-tour-buttons\">\n                            {!isFirstStep && (\n                                <button class=\"ph-tour-button ph-tour-button--secondary\" onClick={onPrevious}>\n                                    Back\n                                </button>\n                            )}\n                            <button class=\"ph-tour-button ph-tour-button--primary\" onClick={onNext}>\n                                {isLastStep ? 'Done' : 'Next'}\n                            </button>\n                        </div>\n                    </div>\n\n                    {!appearance.whiteLabel && (\n                        <a\n                            href=\"https://posthog.com/product-tours\"\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                            class=\"ph-tour-branding\"\n                        >\n                            Tour by {IconPosthogLogo}\n                        </a>\n                    )}\n                </div>\n            </div>\n        )\n    }\n\n    return (\n        <div class=\"ph-tour-container\" style={containerStyle}>\n            <div class=\"ph-tour-click-overlay\" onClick={handleOverlayClick} />\n\n            <div\n                class=\"ph-tour-spotlight\"\n                style={\n                    isVisible && spotlightStyle\n                        ? spotlightStyle\n                        : {\n                              top: '50%',\n                              left: '50%',\n                              width: '0px',\n                              height: '0px',\n                          }\n                }\n            />\n\n            <div\n                class={`ph-tour-tooltip ${isVisible ? 'ph-tour-tooltip--visible' : 'ph-tour-tooltip--hidden'}`}\n                style={{\n                    top: `${position!.top}px`,\n                    left: `${position!.left}px`,\n                    opacity: isVisible ? 1 : 0,\n                    transform: isVisible ? 'translateY(0)' : 'translateY(10px)',\n                    transition: 'opacity 0.15s ease-out, transform 0.15s ease-out',\n                }}\n                onClick={handleTooltipClick}\n            >\n                <div class={`ph-tour-arrow ph-tour-arrow--${getOppositePosition(position!.position)}`} />\n\n                <button class=\"ph-tour-dismiss\" onClick={() => onDismiss('user_clicked_skip')} aria-label=\"Close tour\">\n                    {cancelSVG}\n                </button>\n\n                <div\n                    class=\"ph-tour-content\"\n                    dangerouslySetInnerHTML={{ __html: renderTipTapContent(displayedStep.content) }}\n                />\n\n                <div class=\"ph-tour-footer\">\n                    <span class=\"ph-tour-progress\">\n                        {displayedStepIndex + 1} of {totalSteps}\n                    </span>\n\n                    <div class=\"ph-tour-buttons\">\n                        {!isFirstStep && (\n                            <button class=\"ph-tour-button ph-tour-button--secondary\" onClick={onPrevious}>\n                                Back\n                            </button>\n                        )}\n                        <button class=\"ph-tour-button ph-tour-button--primary\" onClick={onNext}>\n                            {isLastStep ? 'Done' : 'Next'}\n                        </button>\n                    </div>\n                </div>\n\n                {!appearance.whiteLabel && (\n                    <a\n                        href=\"https://posthog.com/product-tours\"\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        class=\"ph-tour-branding\"\n                    >\n                        Tour by {IconPosthogLogo}\n                    </a>\n                )}\n            </div>\n        </div>\n    )\n}\n"]}