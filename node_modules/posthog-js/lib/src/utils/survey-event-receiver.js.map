{"version":3,"file":"survey-event-receiver.js","sourceRoot":"","sources":["../../../src/utils/survey-event-receiver.ts"],"names":[],"mappings":"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","sourcesContent":["import { SURVEYS_ACTIVATED } from '../constants'\nimport { Survey, SurveyEventName, SurveyEventType, SurveyEventWithFilters } from '../posthog-surveys-types'\n\nimport { ActionMatcher } from '../extensions/surveys/action-matcher'\nimport { PostHog } from '../posthog-core'\nimport { CaptureResult } from '../types'\nimport { SURVEY_LOGGER as logger } from './survey-utils'\nimport { matchPropertyFilters } from './property-utils'\nimport { isUndefined } from '@posthog/core'\n\nexport class SurveyEventReceiver {\n    // eventToSurveys is a mapping of event name to all the surveys that are activated by it\n    private _eventToSurveys: Map<string, string[]>\n    // cancelEventToSurveys is a mapping of event name to all the surveys that should be cancelled by it\n    private _cancelEventToSurveys: Map<string, string[]>\n    // actionToSurveys is a mapping of action name to all the surveys that are activated by it\n    private readonly _actionToSurveys: Map<string, string[]>\n    // actionMatcher can look at CaptureResult payloads and match an event to its corresponding action.\n    private _actionMatcher?: ActionMatcher | null\n    private readonly _instance?: PostHog\n\n    constructor(instance: PostHog) {\n        this._instance = instance\n        this._eventToSurveys = new Map<string, string[]>()\n        this._cancelEventToSurveys = new Map<string, string[]>()\n        this._actionToSurveys = new Map<string, string[]>()\n    }\n\n    private _doesEventMatchFilter(\n        eventConfig: SurveyEventWithFilters | undefined,\n        eventPayload?: CaptureResult\n    ): boolean {\n        if (!eventConfig) {\n            return false\n        }\n\n        return matchPropertyFilters(eventConfig.propertyFilters, eventPayload?.properties)\n    }\n\n    private _buildEventToSurveyMap(surveys: Survey[], conditionField: SurveyEventType): Map<string, string[]> {\n        const map = new Map<string, string[]>()\n        surveys.forEach((survey) => {\n            survey.conditions?.[conditionField]?.values?.forEach((event) => {\n                if (event?.name) {\n                    const existing = map.get(event.name) || []\n                    existing.push(survey.id)\n                    map.set(event.name, existing)\n                }\n            })\n        })\n        return map\n    }\n\n    /**\n     * build a map of (Event1) => [Survey1, Survey2, Survey3]\n     * used for surveys that should be [activated|cancelled] by Event1\n     */\n    private _getMatchingSurveys(\n        eventName: string,\n        eventPayload: CaptureResult | undefined,\n        conditionField: SurveyEventType\n    ): Survey[] {\n        const surveyIdMap =\n            conditionField === SurveyEventType.Activation ? this._eventToSurveys : this._cancelEventToSurveys\n        const surveyIds = surveyIdMap.get(eventName)\n\n        let surveys: Survey[] = []\n        this._instance?.getSurveys((allSurveys) => {\n            surveys = allSurveys.filter((survey) => surveyIds?.includes(survey.id))\n        })\n\n        return surveys.filter((survey) => {\n            const eventConfig = survey.conditions?.[conditionField]?.values?.find((e) => e.name === eventName)\n            return this._doesEventMatchFilter(eventConfig, eventPayload)\n        })\n    }\n\n    register(surveys: Survey[]): void {\n        if (isUndefined(this._instance?._addCaptureHook)) {\n            return\n        }\n\n        this._setupEventBasedSurveys(surveys)\n        this._setupActionBasedSurveys(surveys)\n    }\n\n    private _setupActionBasedSurveys(surveys: Survey[]) {\n        const actionBasedSurveys = surveys.filter(\n            (survey: Survey) => survey.conditions?.actions && survey.conditions?.actions?.values?.length > 0\n        )\n\n        if (actionBasedSurveys.length === 0) {\n            return\n        }\n\n        if (this._actionMatcher == null) {\n            this._actionMatcher = new ActionMatcher(this._instance)\n            this._actionMatcher.init()\n            // match any actions to its corresponding survey.\n            const matchActionToSurvey = (actionName: string) => {\n                this.onAction(actionName)\n            }\n\n            this._actionMatcher._addActionHook(matchActionToSurvey)\n        }\n\n        actionBasedSurveys.forEach((survey) => {\n            if (\n                survey.conditions &&\n                survey.conditions?.actions &&\n                survey.conditions?.actions?.values &&\n                survey.conditions?.actions?.values?.length > 0\n            ) {\n                // register the known set of actions with\n                // the action-matcher so it can match\n                // events to actions\n                this._actionMatcher?.register(survey.conditions.actions.values)\n\n                // maintain a mapping of (Action1) => [Survey1, Survey2, Survey3]\n                // where Surveys 1-3 are all activated by Action1\n                survey.conditions?.actions?.values?.forEach((action) => {\n                    if (action && action.name) {\n                        const knownSurveys: string[] | undefined = this._actionToSurveys.get(action.name)\n                        if (knownSurveys) {\n                            knownSurveys.push(survey.id)\n                        }\n                        this._actionToSurveys.set(action.name, knownSurveys || [survey.id])\n                    }\n                })\n            }\n        })\n    }\n\n    private _setupEventBasedSurveys(surveys: Survey[]) {\n        const eventBasedSurveys = surveys.filter(\n            (survey: Survey) => survey.conditions?.events && survey.conditions?.events?.values?.length > 0\n        )\n\n        const surveysWithCancelEvents = surveys.filter(\n            (survey: Survey) => survey.conditions?.cancelEvents && survey.conditions?.cancelEvents?.values?.length > 0\n        )\n\n        if (eventBasedSurveys.length === 0 && surveysWithCancelEvents.length === 0) {\n            return\n        }\n\n        // match any events to its corresponding survey.\n        const matchEventToSurvey = (eventName: string, eventPayload?: CaptureResult) => {\n            this.onEvent(eventName, eventPayload)\n        }\n        this._instance?._addCaptureHook(matchEventToSurvey)\n\n        this._eventToSurveys = this._buildEventToSurveyMap(surveys, SurveyEventType.Activation)\n        this._cancelEventToSurveys = this._buildEventToSurveyMap(surveys, SurveyEventType.Cancellation)\n    }\n\n    onEvent(event: string, eventPayload?: CaptureResult): void {\n        const existingActivatedSurveys: string[] = this._instance?.persistence?.props[SURVEYS_ACTIVATED] || []\n        if (SurveyEventName.SHOWN === event && eventPayload && existingActivatedSurveys.length > 0) {\n            // remove survey that from activatedSurveys here.\n            logger.info('survey event matched, removing survey from activated surveys', {\n                event,\n                eventPayload,\n                existingActivatedSurveys,\n            })\n            const surveyId = eventPayload?.properties?.$survey_id\n            if (surveyId) {\n                const index = existingActivatedSurveys.indexOf(surveyId)\n                if (index >= 0) {\n                    existingActivatedSurveys.splice(index, 1)\n                    this._updateActivatedSurveys(existingActivatedSurveys)\n                }\n            }\n\n            return\n        }\n\n        // check if this event should cancel any pending surveys\n        if (this._cancelEventToSurveys.has(event)) {\n            const surveysToCancel = this._getMatchingSurveys(event, eventPayload, SurveyEventType.Cancellation)\n\n            if (surveysToCancel.length > 0) {\n                logger.info('cancel event matched, cancelling surveys', {\n                    event,\n                    surveysToCancel: surveysToCancel.map((s) => s.id),\n                })\n\n                surveysToCancel.forEach((survey) => {\n                    // remove from activated surveys\n                    const index = existingActivatedSurveys.indexOf(survey.id)\n                    if (index >= 0) {\n                        existingActivatedSurveys.splice(index, 1)\n                    }\n                    // cancel any pending timeout for this survey\n                    this._instance?.cancelPendingSurvey(survey.id)\n                })\n\n                this._updateActivatedSurveys(existingActivatedSurveys)\n            }\n        }\n\n        // if the event is not in the eventToSurveys map, nothing else to do\n        if (!this._eventToSurveys.has(event)) {\n            return\n        }\n\n        logger.info('survey event name matched', {\n            event,\n            eventPayload,\n            surveys: this._eventToSurveys.get(event),\n        })\n\n        const matchedSurveys = this._getMatchingSurveys(event, eventPayload, SurveyEventType.Activation)\n\n        this._updateActivatedSurveys(existingActivatedSurveys.concat(matchedSurveys.map((survey) => survey.id) || []))\n    }\n\n    onAction(actionName: string): void {\n        const existingActivatedSurveys: string[] = this._instance?.persistence?.props[SURVEYS_ACTIVATED] || []\n        if (this._actionToSurveys.has(actionName)) {\n            this._updateActivatedSurveys(existingActivatedSurveys.concat(this._actionToSurveys.get(actionName) || []))\n        }\n    }\n\n    private _updateActivatedSurveys(activatedSurveys: string[]) {\n        // we use a new Set here to remove duplicates.\n        logger.info('updating activated surveys', {\n            activatedSurveys,\n        })\n\n        this._instance?.persistence?.register({\n            [SURVEYS_ACTIVATED]: [...new Set(activatedSurveys)],\n        })\n    }\n\n    getSurveys(): string[] {\n        const existingActivatedSurveys = this._instance?.persistence?.props[SURVEYS_ACTIVATED]\n        return existingActivatedSurveys ? existingActivatedSurveys : []\n    }\n\n    getEventToSurveys(): Map<string, string[]> {\n        return this._eventToSurveys\n    }\n\n    _getActionMatcher(): ActionMatcher | null | undefined {\n        return this._actionMatcher\n    }\n}\n"]}