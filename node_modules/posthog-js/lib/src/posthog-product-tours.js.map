{"version":3,"file":"posthog-product-tours.js","sourceRoot":"","sources":["../../src/posthog-product-tours.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from './posthog-core'\nimport { ProductTour, ProductTourCallback } from './posthog-product-tours-types'\nimport { RemoteConfig } from './types'\nimport { createLogger } from './utils/logger'\nimport { isNullish, isUndefined, isArray } from '@posthog/core'\nimport { assignableWindow } from './utils/globals'\n\nconst logger = createLogger('[Product Tours]')\n\nconst PRODUCT_TOURS_STORAGE_KEY = 'ph_product_tours'\nconst PRODUCT_TOURS_FEATURE_FLAG = 'product-tours-2025'\n\ninterface ProductTourManagerInterface {\n    start: () => void\n    stop: () => void\n    showTourById: (tourId: string) => void\n    dismissTour: (reason: string) => void\n    nextStep: () => void\n    previousStep: () => void\n    getActiveProductTours: (callback: ProductTourCallback) => void\n    resetTour: (tourId: string) => void\n    resetAllTours: () => void\n}\n\nexport class PostHogProductTours {\n    private _instance: PostHog\n    private _cachedTours: ProductTour[] | null = null\n    private _productTourManager: ProductTourManagerInterface | null = null\n    private _isProductToursEnabled?: boolean = undefined\n    private _isInitializing: boolean = false\n\n    constructor(instance: PostHog) {\n        this._instance = instance\n    }\n\n    onRemoteConfig(response: RemoteConfig): void {\n        if (this._instance.config.disable_product_tours) {\n            logger.info('Product tours disabled via config')\n            return\n        }\n\n        const productTours = response['productTours']\n        if (isNullish(productTours)) {\n            logger.info('Product tours not enabled in remote config')\n            return\n        }\n\n        this._isProductToursEnabled = productTours\n        logger.info(`Remote config received, isProductToursEnabled: ${this._isProductToursEnabled}`)\n        this.loadIfEnabled()\n    }\n\n    loadIfEnabled(): void {\n        if (this._productTourManager) {\n            return\n        }\n        if (this._isInitializing) {\n            logger.info('Already initializing product tours, skipping...')\n            return\n        }\n        if (this._instance.config.disable_product_tours) {\n            logger.info('Product tours disabled via config')\n            return\n        }\n\n        const phExtensions = assignableWindow?.__PosthogExtensions__\n        if (!phExtensions) {\n            logger.error('PostHog Extensions not found.')\n            return\n        }\n\n        const featureFlagEnabled = this._instance.featureFlags?.isFeatureEnabled(PRODUCT_TOURS_FEATURE_FLAG)\n\n        if (isUndefined(this._isProductToursEnabled) && !featureFlagEnabled) {\n            logger.info('Waiting for remote config or feature flag to enable product tours')\n            return\n        }\n\n        const isEnabled = this._isProductToursEnabled || featureFlagEnabled\n        if (!isEnabled) {\n            logger.info('Product tours not enabled')\n            return\n        }\n\n        this._isInitializing = true\n\n        try {\n            const generateProductTours = phExtensions.generateProductTours\n            if (generateProductTours) {\n                this._completeInitialization(generateProductTours, isEnabled)\n                return\n            }\n\n            const loadExternalDependency = phExtensions.loadExternalDependency\n            if (!loadExternalDependency) {\n                logger.error('PostHog loadExternalDependency extension not found.')\n                this._isInitializing = false\n                return\n            }\n\n            loadExternalDependency(this._instance, 'product-tours', (err) => {\n                if (err || !phExtensions.generateProductTours) {\n                    logger.error('Could not load product tours script', err)\n                } else {\n                    this._completeInitialization(phExtensions.generateProductTours, isEnabled)\n                }\n                this._isInitializing = false\n            })\n        } catch (e) {\n            logger.error('Error initializing product tours', e)\n            this._isInitializing = false\n        }\n    }\n\n    private _completeInitialization(\n        generateProductToursFn: (instance: PostHog, isEnabled: boolean) => ProductTourManagerInterface | undefined,\n        isEnabled: boolean\n    ): void {\n        this._productTourManager = generateProductToursFn(this._instance, isEnabled) || null\n        logger.info('Product tours loaded successfully')\n    }\n\n    getProductTours(callback: ProductTourCallback, forceReload: boolean = false): void {\n        if (isArray(this._cachedTours) && !forceReload) {\n            callback(this._cachedTours, { isLoaded: true })\n            return\n        }\n\n        const persistence = this._instance.persistence\n        if (persistence) {\n            const storedTours = persistence.props[PRODUCT_TOURS_STORAGE_KEY]\n            if (isArray(storedTours) && !forceReload) {\n                this._cachedTours = storedTours\n                callback(storedTours, { isLoaded: true })\n                return\n            }\n        }\n\n        this._instance._send_request({\n            url: this._instance.requestRouter.endpointFor(\n                'api',\n                `/api/product_tours/?token=${this._instance.config.token}`\n            ),\n            method: 'GET',\n            callback: (response) => {\n                const statusCode = response.statusCode\n                if (statusCode !== 200 || !response.json) {\n                    const error = `Product Tours API could not be loaded, status: ${statusCode}`\n                    logger.error(error)\n                    callback([], { isLoaded: false, error })\n                    return\n                }\n\n                const tours: ProductTour[] = isArray(response.json.product_tours) ? response.json.product_tours : []\n\n                this._cachedTours = tours\n\n                if (persistence) {\n                    persistence.register({ [PRODUCT_TOURS_STORAGE_KEY]: tours })\n                }\n\n                callback(tours, { isLoaded: true })\n            },\n        })\n    }\n\n    getActiveProductTours(callback: ProductTourCallback): void {\n        if (isNullish(this._productTourManager)) {\n            logger.warn('Product tours not loaded yet')\n            callback([], { isLoaded: false, error: 'Product tours not loaded' })\n            return\n        }\n        this._productTourManager.getActiveProductTours(callback)\n    }\n\n    showProductTour(tourId: string): void {\n        logger.info(`showProductTour(${tourId})`)\n        this._productTourManager?.showTourById(tourId)\n    }\n\n    dismissProductTour(): void {\n        this._productTourManager?.dismissTour('user_clicked_skip')\n    }\n\n    nextStep(): void {\n        this._productTourManager?.nextStep()\n    }\n\n    previousStep(): void {\n        this._productTourManager?.previousStep()\n    }\n\n    clearCache(): void {\n        this._cachedTours = null\n\n        const persistence = this._instance.persistence\n        if (persistence) {\n            persistence.unregister(PRODUCT_TOURS_STORAGE_KEY)\n        }\n    }\n\n    resetTour(tourId: string): void {\n        this._productTourManager?.resetTour(tourId)\n    }\n\n    resetAllTours(): void {\n        this._productTourManager?.resetAllTours()\n    }\n}\n"]}